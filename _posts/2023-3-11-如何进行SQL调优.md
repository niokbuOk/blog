## 如何进行SQL调优

记录一次SQL调优学习内容

#### 第一步 定位问题

首先需要定位到具体的SQL语句，这个可以通过各种监控平台或者工具来实现，比如慢SQL日志，通过定位到SQL语句之后，我们就知道具体是哪张表，哪个慢SQL慢了。

#### 第二步 分析原因

一个SQL慢，可能有以下几种原因：

1. 索引失效
2. 多表join
3. 查询字段太多
4. 表中数据量太大
5. 索引区分度不高
6. 数据库连接数不够
7. 数据库的表结构不合理
8. 数据库IO或者CPU比较高
9. 数据库参数不合理
10. 事务比较长
11. 锁竞争导致的等待

一次完整的SQL调优，一般需要考虑以上几个元素，一般会涉及到几种的一个或者多个问题。那么就需要逐个调优。

#### 第三步 逐步调优

1. **索引失效**: 根据执行计划分析是否走了索引，以及走的索引是否符合预期，如果不符合预期则修改SQL语句或者修改索引。详细参考

   [名称索引失效解决](https://niokbuok.github.io/blog/%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E6%8E%92%E6%9F%A5/)

2. **多表join**: 不建议使用不多join，主要的原因是join的效率比较低，以为MySQL使用的是嵌套循环的方式来实现关联查询的，以第一张表做外循环，第二张表做内循环，外循环的每一条记录和内循环所有记录比较，符合条件就输出。所以如果有2张表，时间复杂度就是0（n^2） 3张就是0（n^3）....

3. **查询字段太多**：使用select * 的时候，一般来说，字段小于100个，都不是大问题，触发真的是字段特别多，这可以采用两种方法来优化 第一种是只查询自己关心的字段，只查询少部分字段。第二个就是做分表，垂直分表，把数据拆分到多张表中。但是这样会增加一些额外的维护成本，并且也可能带来多表join的问题。

4. **数据量太大**：如果表单超过1000万，会导致查询效率变低，即使使用索引可能也会比较慢，所以如果表中数据量太大，即使建立索引也不一定完全解决。解决方案:

   1. 数据归档，把历史数据移出去，比如只保留近半年的数据，半年前的数据做归档。
   2. 分库分表分区，把数据拆分开。
   3. 把数据同步到支持大量查询的分布式数据库中，比如es。

5. **索引区分度不够**：索引区分度不高，导致优化器认为全表扫描成本差不多

6. **数据库连接数不够**：可能的原因有两个，第一个就是业务量太大了，单库扛不住了，那就选择分库。第二个可能就是存在一些慢SQL，或者长事务导致的，慢SQL占用数据库连接，数据库连接不够，其他的查询就会阻塞，就会很慢。

7. **数据库的表结构不合理**: 比如某个字段存储了很长的内容，或者没有做合理的冗余需要多表查询，解决的思路就是重构，或者分表。

8. **数据库的IO或者CPU比较高：**当数据库整体IO或者CPU飙高的时候，查询速度就可能下降，所以需要分析背后的原因。

9. **存在长事务：**这个和慢SQL同理，都是占用了数据库连接，导致其他连接需要等待。

10. **锁竞争导致的等待：**当有大并发争抢共享资源的时候，就会导致锁等待，这个过程就会拉长耗时，导致SQL变慢。

11. **数据库参数不合理:**这个也是经常会遇到的，针对我们具体的业务场景，做一些适当的参数调整，有时候也能大大的提示SQL的效率，比如调整内存大小，缓存大小，线程池大小等。
